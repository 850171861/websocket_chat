<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
    </head>
    <body>
        <div id="app">
            <div v-if="isShow">
                <input type="text" v-model="name" />
                <button type="button" @click="enter()">进入聊天室</button>
            </div>
            <div v-else>
                <ul>
                    <li v-for="(item,index) in lists" :key="'message'+index">{{item}}</li>
                    <li>在线人数 {{num}}</li>
                </ul>
                <input type="text" v-model="message" />
                <button type="button" v-on:click="send()">发送</button>
            </div>
        </div>

        <!-- <button type="button" id="send">发socket</button>
        <button type="button" id="close">关闭socket</button> -->
        <script>
            var app = new Vue({
                el: "#app",
                data: {
                    message: "",
                    lists: [],
                    ws: {},
                    name: "",
                    isShow: true,
                    num: 0,
                },
                mounted() {
                    this.ws = new WebSocket("ws://localhost:3003");
                    this.ws.onopen = this.onOpen;
                    this.ws.onmessage = this.onMessage;
                    this.ws.onclose = this.onClose;
                    this.ws.onerror = this.onError;
                },
                methods: {
                    enter() {
                        if (this.name.trim() === "") {
                            alert("用户名不能为空");
                            return;
                        }
                        this.isShow = false;
                        this.ws.send(
                            JSON.stringify({
                                event: "enter",
                                message: this.name,
                            })
                        );
                    },

                    onOpen: function () {
                        console.log("open" + this.ws.readyState);
                    },
                    onMessage: function (event) {
                        if (this.isShow) {
                            return;
                        }
                        //接送服务端发送过来信息
                        var obj = JSON.parse(event.data);
                        //当有一个新用户进入聊天室
                        if (obj.event === "enter") {
                            this.lists.push("欢迎" + obj.message + "加入聊天室");
                        } else if (obj.event === "out") {
                            this.lists.push(obj.name + "已经退出聊天室");
                        } else {
                            if (obj.name != this.name) {
                                //接送正常聊天
                                this.lists.push(obj.name + ":" + obj.message);
                            }
                        }
                        this.num = obj.num;
                    },
                    onClose: function () {
                        console.log(this.ws.readyState);
                        console.log("close关闭");
                    },
                    onError: function () {
                        console.log(this.ws.readyState);
                        console.log("连接失败");
                    },
                    //发送信息
                    send: function () {
                        this.lists.push(this.name + ":" + this.message);
                        this.ws.send(
                            JSON.stringify({
                                event: "message",
                                message: this.message,
                                name: this.name,
                            })
                        );
                        this.message = "";
                    },
                },
            });
            // var ws = new WebSocket("ws://localhost:3003");
            // //发送信息
            // ws.onopen = function () {
            //     // ws.send("dddd");
            // };
            // //接送信息
            // ws.onmessage = function (msg) {};
            // //连接端口触发close事件
            // ws.onclose = function () {
            //     console.log(ws.readyState);
            //     console.log("close关闭");
            // };
            // //连接失败触发error事件
            // ws.oneeror = function () {
            //     console.log(ws.readyState);
            //     console.log("连接失败");
            // };
            // document.getElementById("send").addEventListener("click", function () {
            //     var inputValue = document.getElementById("msg").value;
            //     ws.send(inputValue);
            //     inputValue = "";
            // });

            // document.getElementById("close").addEventListener("click", function () {
            //     ws.close();
            // });
        </script>
    </body>
</html>
